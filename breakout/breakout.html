<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Breakout</title>
    <style>
        * { padding: 0; margin: 0; }
        canvas { background: #eee; display: block; margin: 0 auto; }
    </style>
    <script src="physicsjs/dist/physicsjs-full.min.js"></script>
</head>
<body>

<canvas id="playground" width="480" height="320"></canvas>

<script>

    var canvas = document.getElementById("playground");
    var ctx = canvas.getContext("2d");
    var score = 0;
    var lives = 3;
    var isRunning = true;

    var x = canvas.width/2;
    var y = canvas.height - 50;
    var dx = 1;
    var dy = -2;
    var ballRadius = 10;

    var padWidth = 100;
    var padHeight = 10;
    var padX = canvas.width/2 - padWidth;
    var padY = canvas.height-10;
    
    // pad controls
    var rightPressed = false;
    var leftPressed = false;

    // bricks
    var brickRowCount = 4;
    var brickColumnCount = 5;
    var brickWidth = 75;
    var brickHeight = 20;
    var brickPadding = 10;
    var brickOffsetTop = 30;
    var brickOffsetLeft = 30;

    var totalBricks = brickRowCount * brickColumnCount;
    // init bricks

    var bricks = [];
    for(col = 0; col < brickColumnCount; col++) {
        bricks[col] = [];
        for(row = 0; row < brickRowCount; row++) {
            if (row == 0) {
                bricks[col][row] = { x: 0, y: 0, status: 2 };
            } else {
                bricks[col][row] = { x: 0, y: 0, status: 1 };
            }
        }
    }

    document.addEventListener("keydown", keyDownHandler, false);
    document.addEventListener("keyup", keyUpHandler, false);
    document.addEventListener("mousemove", mouseMoveHandler, false);

    function run() {
        if (isRunning) {
            UpdateGameState();
            draw();
        }

        requestAnimationFrame(run);
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawBricks();
        drawBall();
        drawPad();
        drawHUD();
    }

    function UpdateGameState() {
        collisionDetection();
        updateBallPosition();
        updatePadPosition();
    }

    function drawBall() {
        ctx.beginPath();
        ctx.arc(x, y, ballRadius, 0, 2*Math.PI);
        ctx.fillStyle = "#0095DD";
        ctx.fill();
        ctx.closePath();
    }

    function drawPad() {
        ctx.beginPath();
        ctx.rect(padX, padY, padWidth, padHeight);
        ctx.fillStyle = "#0095DD";
        ctx.fill();
        ctx.closePath();
    }

    function drawBricks() {
        for(col = 0; col < brickColumnCount; col++) {
            for(row = 0; row < brickRowCount; row++) {
                if (bricks[col][row].status > 0) {
                    var brickX = (col*(brickWidth+brickPadding))+brickOffsetLeft;
                    var brickY = (row*(brickHeight+brickPadding))+brickOffsetTop;
                    
                    bricks[col][row].x = brickX;
                    bricks[col][row].y = brickY;
                   
                    ctx.beginPath();
                    ctx.rect(brickX, brickY, brickWidth, brickHeight);
                    
                    if (bricks[col][row].status == 1) {
                        ctx.fillStyle = "#0095DD";
                    } else {
                        ctx.fillStyle = "#DDDD00";
                    }
                    ctx.fill();
                    ctx.closePath();
                }
            }
        }
    }

    function drawHUD() {
        drawScore();
        drawLives();
    }

    function drawScore() {
        ctx.font = "16px Arial";
        ctx.fillStyle = "#0095DD";
        ctx.fillText("Score: " + score, 8, 20);
    }

    function drawLives() {
        ctx.font = "16px Arial";
        ctx.fillStyle = "#0095FF";
        ctx.fillText("Lives: " + lives, 100, 20);
    }

    function resetBall() {
        var x = canvas.width/2;
        var y = canvas.height - 50;
        var dx = 0.3;
        var dy = -2;
    }

    function updateBallPosition() {
        if(y + dy < ballRadius) {
             dy = -dy;
        } else if(y + dy > canvas.height-ballRadius) {
            if(x + ballRadius > padX && x - ballRadius < padX + padWidth) {
                AdjustXVelocity();
                dy = -dy;
            } else {
                die();
            }
        }

        if (x + dx <= ballRadius || x + dx >= canvas.width - ballRadius) {
            dx = -dx;
        }

        x += dx;
        y += dy;
    }

    function updatePadPosition() {
        if (leftPressed) {
            padX = padX - 3 >= 0 ? padX - 3 : 0;
        } else if (rightPressed) {
            padX = padX + 3 +padWidth <= canvas.width ? padX + 3 : padX;
        }
    }

    function collisionDetection() {
        for(col = 0; col < brickColumnCount; col++) {
            for(row = 0; row < brickRowCount; row++) {
                
                var brick = bricks[col][row];
                
                if(BallCollidesWithBrickTopBottom(brick)) {
                    dy = -dy;
                    DestroyBrick(brick);
                    bricks[col][row] = {};
        
                } else if (BallCollidesWithBrickSide(brick)) {
                    dx = -dx;
                    DestroyBrick(brick);
                    bricks[col][row] = {};
                }

                if (totalBricks == 0) {
                    GameOver();
                }
            }
        }
    }

    function BallCollidesWithBrickTopBottom(brick) {
        // colide with bottom of brick
        if ((y - ballRadius) == (brick.y + brickHeight) && x > brick.x && x < (brick.x + brickWidth)) {
            return true;
        }  else if ((y + ballRadius) == brick.y && x > brick.x && x < (brick.x + brickWidth)) { // colide with top of brick
            return true;
        } 
        return false;
    }

    function BallCollidesWithBrickSide(brick) {
        if (y > brick.y && y < (brick.y + ballRadius) && (x - ballRadius) == (brick.x + brickWidth)) { // colide with right side of brick
            return true;
        } else if ((x + ballRadius) == brick.x && y > brick.y && y < (brick.y + brickHeight)) { // colide with left side of brick
            return true;
        }

        return false;
    }

    function DestroyBrick(brick) {
        brick.status--;
                    
        if (brick.status == 0) {
            score += 10;
            totalBricks--;
        }
    }

    function AdjustXVelocity() {
        var padCenter = padX + (padWidth / 2);
        var padEndX = padX + padWidth;
        
        if (dx > 0) { // ball is going right
            if (x < padCenter) { // hit with left part of pad
                if (x > padCenter - 10 && x < padCenter) { 
                    dx = -0.2;
                } else if (x < (padCenter - 10) && x > (padCenter - 25)) {
                    dx = -0.7;  
                } else if (x < (padCenter - 25) && x > (padCenter - 40)) {
                    dx = -1;  
                } else if (x < (padCenter - 40) && x > padX) {
                    dx = -1.5;  
                }
            } else { // hit with right part of pad
                if (x > padCenter && x < padCenter + 10) { 
                    dx = 0.2;
                } else if (x > padCenter + 10 && x < padCenter + 25) {
                    dx = 0.7;  
                } else if (x > padCenter + 25 && x < padCenter + 40) {
                    dx = 1;  
                } else if (x > padCenter + 40 && x < padEndX) {
                    dx = 1.5;  
                }
            }
        } else { // ball is going left
            if (x > padCenter) { // hit with right part of pad
                if (x > padCenter && x < (padCenter + 10)) { 
                    dx = 0.2;
                } else if (x > (padCenter + 10) && x < (padCenter + 25)) {
                    dx = 0.7;  
                } else if (x > (padCenter + 25) && x < (padCenter + 40)) {
                    dx = 1;  
                } else if (x > (padCenter + 40) && x < padEndX) {
                    dx = 1.5;  
                }
            } else { // hit with left part of pad
                if (x > (padCenter - 10) && x < padCenter) { 
                    dx = -0.2;
                } else if (x < (padCenter - 10) && x > (padCenter - 25)) {
                    dx = -0.7;  
                } else if (x < (padCenter - 25) && x > (padCenter - 40)) {
                    dx = -1;  
                } else if (x < (padCenter - 40) && x > padX) {
                    dx = -1.5;  
                }
            }            
        }
    }

    function keyDownHandler(key) {
        if(key.keyCode == 39) {
            rightPressed = true;
        } else if(key.keyCode == 37) {
            leftPressed = true;
        }
    }

    function keyUpHandler(key) {
        if(key.keyCode == 39) {
            rightPressed = false;
        } else if(key.keyCode == 37) {
            leftPressed = false;
        }
    }

    function mouseMoveHandler(e) {
        var relativeX = e.clientX - canvas.offsetLeft;
        if(relativeX > 0 && relativeX < canvas.width) {
            padX = relativeX - padWidth/2;
        }
    }

    function die() {
        lives--;
        if (lives <= 0) {
            GameOver();
        } else {
            resetBall();
        }
    }

    function GameOver() {
        isRunning = false;
        resetBall();
        document.removeEventListener("keydown", keyDownHandler);
        document.removeEventListener("keyup", keyUpHandler);
        document.removeEventListener("mousemove", mouseMoveHandler);
    }

    run();

    
</script>

</body>
</html>